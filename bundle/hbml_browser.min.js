/*! hbml 2022-12-29 01:30 */
const LITERAL_DELIMITERS="\"'`",VOID_ELEMENTS=["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr","!DOCTYPE",":child",":children"],INLINE_ELEMENTS=["abbr","acronym","audio","b","bdi","bdo","big","br","button","canvas","cite","code","data","datalist","del","dfn","em","embed","i","iframe","img","input","ins","kbd","label","map","mark","meter","noscript","object","output","picture","progress","q","ruby","s","samp","script","select","slot","small","span","strong","sub","sup","svg","template","textarea","time","u","tt","var","video","wbr"],UNIQUE_ATTRS=["lang","id"],BUILTIN_MACROS=[":child",":children",":consume",":consume-all"],DEFAULT_ALLOW={write:!1,not_found:!1,parse:!1},CONFIG_DEFAULTS={"lint.src":["/"],"lint.output":"/","lint.allow.not_found":!1,"lint.allow.write":!1,"lint.allow.parse":!1,"lint.config.indent.character":"\t","lint.config.indent.count":1,"lint.config.pre_tag_space":1,"lint.config.post_tag_space":1,"lint.config.inline_same_line":!0,"lint.config.keep_implicit":!0,"lint.config.void_inline":!0,"lint.config.element_preference":"preserve","lint.config.remove_empty":!1,"build.src":["/"],"build.output":"html","build.allow.not_found":!1,"build.allow.write":!1,"build.allow.parse":!1};class Token{type;attributes;additional;children;constructor(e,r,t={},n){this.type=e,this.attributes=r,this.additional=t,this.children=n}toString(){switch(this.type){case"c t":return`<!--${this.additional.value}-->`;case"!DOCTYPE":return"<!DOCTYPE html>";default:var e=0===Object.keys(this.attributes).length?"":" "+Object.entries(this.attributes).reduce((e,[r,t])=>!0===t?e+" "+r:e+` ${r}="${t}"`,"").slice(1);return this.additional.void?`<${this.type}${e}${"!DOCTYPE"===this.type?"":"/"}>`:`<${this.type}${e}>${this.children.reduce((e,r)=>""+e+r.toString(),"")}</${this.type}>`}}lint(t,e,n){switch(n["lint.config.element_preference"]){case"arrow":1===this.children.length&&(this.additional.inline=!0);break;case"bracket":this.additional.inline=!1}n["lint.config.remove_empty"]&&0===this.children.length&&(this.additional.void=!0);let i=n["lint.config.indent.character"].repeat(e?0:t*n["lint.config.indent.count"]);if("c t"===this.type)return`${i}/* ${this.additional.value.trim()} */\n`;var r=Object.entries(this.attributes).filter(([e])=>"id"!==e&&"class"!==e),r=0<Object.keys(r).length?r.reduce((e,[r,t])=>!0===t?e+" "+r:`${e} ${r}="${t.replaceAll('"','\\"')}"`,"").slice(1):"",r=""+(this.additional.implicit&&!n["lint.config.replace_implicit"]?"":this.type)+(this.attributes.id?"#"+this.attributes.id:"")+(this.attributes.class?"."+this.attributes.class.replaceAll(" ","."):"")+(r?`[${r}]`:"");if(this.additional.void)return i+r+`
`;let l=i+r+" ".repeat(r?n["lint.config.pre_tag_space"]:0)+(this.additional.inline?">"+" ".repeat(n["lint.config.inline_same_line"]?n["lint.config.post_tag_space"]:0):"{");return this.additional.inline&&n["lint.config.inline_same_line"]?(r=this.children.pop(),l+="string"==typeof r?`"${r}"`:r.lint(t,!0,n)):(0!==this.children.length&&(l+="\n"),i=n["lint.config.indent.character"].repeat(t*n["lint.config.indent.count"]),l+=this.children.reduce((e,r)=>e+("string"==typeof r?""+i+n["lint.config.indent.character"]+`"${r}"
`:r.lint(t+1,!1,n)),""),this.additional.inline||(l+=`${0!==this.children.length?i:" ".repeat(n["lint.config.post_tag_space"])}}`)),l+(e?"":"\n")}count_child(){let t=0,n=!0,i=!1;return this.children=this.children.map(e=>{var r;return"string"!=typeof e&&(":child"===e.type||":unwrap-child"===e.type?(t++,n=!1):":children"===e.type?(this.additional.children=!0,n=!1):(e=(r=e.count_child()).tok,i=i||e.additional.children,n=n&&r.isVoid,[":consume",":consume-all"].includes(e.type)||(t+=e.additional["child count"]))),e}),this.additional["child count"]=t,this.additional.children=i,{tok:this,isVoid:n}}replace(t){switch(this.type){case":child":var e=t.pop();return[e||""];case":unwrap-child":return t.at(-1)?.children?t.pop().children:[""];case":children":var r=t.length,n=[];for(let e=0;e<r;e++)n.push(t.pop());return n;case":consume":return t.length>=this.additional["child count"]?this.children.reduce((e,r)=>{return"string"==typeof r?{expand:[...e.expand,r],rem:e.rem}:(r=r.replace(t),[...e,...r])},[]):[];case":consume-all":if(t.length>=this.additional["child count"]){let e=[];for(;t.length>=this.additional["child count"];)e=this.children.reduce((e,r)=>{return"string"==typeof r?[...e,r]:(r=r.replace(t),[...e,...r])},e);return e}return[];default:e=this.children.reduce((e,r)=>{return"string"==typeof r?[...e,r]:(r=r.replace(t),[...e,...r])},[]);return[new Token(this.type,this.attributes,this.additional,e)]}}expand(r){let t=[];var e,n,i;return this.children.map(e=>{if("string"==typeof e)t.push(e);else{e=e.expand(r);if(e.err)return{ok:null,err:e.err};t=[...t,...e.ok]}}),":"!==this.type[0]||BUILTIN_MACROS.includes(this.type)?{ok:[new Token(this.type,Object.assign({},this.attributes),Object.assign({},this.additional),t)],err:null}:({ok:e,err:n}=r.get_macro(this.type.slice(1)),n?{ok:null,err:n}:"function"==typeof e?{ok:e(t),err:null}:e.void?(i=e.get_rep(r)).err?{ok:null,err:n}:{ok:[...i.ok,...t],err:null}:e.expand(t,this.attributes,r))}}class Macro{constructor(e,r){return this.rep=e,this.void=r,this}expand(r,t,n){r.reverse();let i=[];for(let e=0;e<this.rep.length;e++)"string"==typeof this.rep[e]?i.push(this.rep[e]):i=[...i,...this.rep[e].replace(r)];let l=[];return i.forEach(e=>{if("string"==typeof e)l.push(e);else{e=e.expand(n);if(e.err)return{ok:null,err:e.err};l=[...l,...e.ok]}}),0===l.length&&delete t.id,1===l.length&&("string"!=typeof l[0]&&void 0!==t.id&&(l[0].attributes.id=t.id),delete t.id),void 0!==t.id?{ok:null,err:"ID cannot be applied to a macro with multiple root elements"}:(l.map(e=>{if("string"!=typeof e)for(const r in t)!UNIQUE_ATTRS.includes(r)&&void 0!==e.attributes[r]&&"string"==typeof e.attributes[r]?e.attributes[r]+=" "+t[r]:e.attributes[r]=t[r];return e}),{ok:l,err:null})}get_rep=t=>{let n=[];return this.rep.map(e=>{if("string"==typeof e)n.push(e);else{var{ok:e,err:r}=e.expand(t);if(r)return{ok:null,err:r};n=[...n,...e]}}),{ok:n,err:null}}}const DEFAULT_MACROS={root:new Macro([new Token("!DOCTYPE",{html:!0},{},[]),new Token("html",{lang:"en"},{"child count":0,children:!0},[new Token(":children",{},{},[])])],!1),unwrap:e=>{let r=[];return e.forEach(e=>{"string"==typeof e||"c t"===e.type?r.push(e):r=[...r,...e.children]}),r}};class Error{constructor(e,r,t,n){this.desc=e,this.file=r,this.ln=t,this.col=n}toString(){return`${this.desc} ${this.file} ${this.ln}:`+this.col}}const convert=r=>{if("#text"===r.nodeName)return r.data;if("#comment"===r.nodeName)return new Token("c t",{},{value:r.nodeValue},[]);let t=[];r.childNodes.forEach(e=>t.push(convert(e)));var n={};for(let e=0;e<r.attributes.length;e++)n[r.attributes.item(e).nodeName]=r.attributes.item(e).nodeValue;return new Token(r.localName,n,{},t)},lint_opts={...CONFIG_DEFAULTS,"lint.config.element_preference":"arrow","lint.config.remove_empty":!0},snippet=e=>{let r=[];return(new DOMParser).parseFromString(e,"text/html").body.childNodes.forEach(e=>r.push(convert(e))),r.map(e=>"object"==typeof e?e.lint(0,!1,lint_opts):e).join("")},full=e=>{let r=[];e=(new DOMParser).parseFromString(e,"text/html").head.parentElement;return e.childNodes.forEach(e=>r.push(convert(e))),new Token(":root","en"!==e.lang?{lang:e.lang}:{},{},r).lint(0,!1,lint_opts)};const handleImport=e=>{e.index+=7,e.st();let r="";for(;e.remaining()&&!" \t\n".includes(e.next());)r+=e.next(),e.index++,e.col++;let t="";if(e.remaining()&&"\n"!==e.next()){for(e.st();e.remaining()&&!".#[{>]}'\"` \t\n".includes(e.next());)t+=e.next(),e.index++,e.col++;t+=":"}let n;if(r.startsWith("http")){var i=new XMLHttpRequest;if(i.open("GET",r,!1),i.send(null),200!==i.status)return{ok:null,err:`Unable to access ${r} (response ${i.status} '${i.responseText}')`};n=i.responseText}else{switch(r=npath.join(npath.isAbsolute(r)?"":process.cwd(),r),npath.extname(r)){case"":r+=".hbml";break;case".hbml":break;default:return{ok:null,err:`Cannot import non-HBML file ${r}!`+fs.existsSync(r)?"":"File also doesn't exist!"}}if(!fs.existsSync(r))return{ok:null,err:`Imported file ${r} does not exist`};n=fs.readFileSync(r).toString()}var{ok:l,err:i}=e.new(n,r,!0).import_parse(t);if(null!==i)return{ok:null,err:`Error importing file ${r} (${i.toString()})`};e.update_src();for(const o in l){if(void 0!==e.macros[e.macros.length-1][o])return{ok:null,err:"Cannot redefine macros through imports. Try using a namespace instead"};e.macros[e.macros.length-1][o]=l[o]}return{ok:null,err:null}},import_parse=(e,r)=>{var t=e.parse()["err"];if(null!==t)return{ok:null,err:t};let n=Object.assign({},e.macros[0]);if(Object.keys(DEFAULT_MACROS).forEach(e=>delete n[e]),""===r)return{ok:n,err:null};const i=e=>"string"==typeof e?e:(":"!==e.type[0]||BUILTIN_MACROS.includes(e.type)||(e.type=":"+r+e.type.slice(1)),new Token(e.type,e.attributes,e.additional,e.children.map(e=>i(e))));var l={};for(const o in n)l[""+r+o]=new Macro(n[o].rep.map(e=>i(e)),n[o].void);return{ok:l,err:null}};const get_macro=(e,r)=>{let t=void 0,n=e.macros.length;for(;0<n;){n--;var i=e.macros[n][r];if(i){t=i;break}}return void 0===t?{ok:null,err:"Unknown macro :"+r}:{ok:t,err:null}},parse_macro_def=e=>{var r,t,{ok:n,err:i}=e.parse_inner("div",!1,!0);return i?{ok:null,err:i}:(r=(i=n[0].count_child()).tok,(t=e.get_macro(r.type)).ok&&t.ok.void!==i.isVoid?{ok:null,err:"Macro redefinitions must preserve voidness"}:(e.macros[e.macros.length-1][r.type]=new Macro(r.children,i.isVoid),e.update_src(),e.isBuild?{ok:null,err:null}:{ok:[new Token("--"+n[0].type,n[0].attributes,{...n[0].additional,void:0===r.children.length},r.children)],err:null}))};const parse_inner=(e,r,t,n)=>{if(e.stn(),!e.remaining()||"}"===e.next())return{ok:null,err:null};if(LITERAL_DELIMITERS.includes(e.next()))return(i=e.parseStr(e.next(),t)).err?{ok:null,err:i.err}:{ok:[i.ok],err:null};if("-"===e.next()&&"-"===e.src[e.index+1])return e.index+=2,e.parse_macro_def();if("/"===e.next())return e.src=e.src.slice(e.index),(i=e.parseComment()).err?{ok:null,err:i.err}:{ok:[i.ok],err:null};if(e.src.startsWith("@import",e.index))return e.handleImport();var i=e.parseTag(r);if(i.err)return{ok:null,err:i.err};var{type:i,attrs:l,additional:o}=i.ok;let s=void 0;if(":"===i[0]&&!BUILTIN_MACROS.includes(i)){if(":"===i)return{ok:null,err:"Macro cannot have an empty name"};if(!n){var{ok:a,err:c}=e.get_macro(i.slice(1));if(null===a&&e.isBuild)return{ok:null,err:c};if((s=a).void)return e.update_src(),e.isBuild?{ok:a.expand([],l,e).ok,err:null}:{ok:[new Token(i,l,o,[])],err:null}}}if(o.void)return e.update_src(),{ok:[new Token(i,l,o,[])],err:null};let d=[];if(r=INLINE_ELEMENTS.includes(i)?"span":"div",t="style"!==i,e.st(),!e.remaining())return e.update_src(),void 0===s?{ok:[new Token(i,l,o,[])],err:null}:"object"==typeof s?s.expand([],l,e):{ok:s([]),err:null};if(">"===e.next()){o.inline=!0,e.index++,e.col++,e.update_src(),e.macros.push({});c=e.parse_inner(r,t,n);if(e.macros.pop(),c.err)return{ok:null,err:c.err};null!==c.ok&&(d=[...d,...c.ok])}else if("{"===e.next()){for(e.macros.push({}),e.index++,e.col++,e.update_src();e.remaining()&&"}"!==e.next();){var u=e.parse_inner(r,t,n);if(u.err)return{ok:null,err:u.err,rem:""};null!==u.ok&&(d=[...d,...u.ok]),e.stn()}if(!e.remaining())return{ok:null,err:"Unclosed block! Expected closing '}' found EOF!"};e.macros.pop(),e.index++,e.col++}return e.update_src(),void 0!==s&&e.isBuild?"object"==typeof s?s.expand(d,l,e):{ok:s(d),err:null}:{ok:[new Token(i,l,o,d)],err:null}},convertReservedChar=(e,r)=>{var t={"<":"&lt;",">":"&gt;"};for(const n in t)r=r.replaceAll(n,t[n]);return r},parseComment=e=>{let r="";var t="*"===e.src[1];if(!t&&"/"!==e.src[1])return{ok:null,err:"Expected '*' or '/' after /"};for(e.index=2;;){if(!e.remaining()){if(t)return{ok:null,err:"Expected end of comment! Found EOF"};break}var n=e.next();if(e.index++,e.col++,t&&"*"===n&&"/"===e.next()){e.index++;break}if("\n"===n){if(!t)break;r+=n,e.col=0,e.ln++}else r+=n}return e.update_src(),{ok:new Token("c t",{},{value:r},[]),err:null}},parseStr=(e,r,t)=>{e.index++,e.col++;let n="",i=!1;for(;e.remaining();){if("\\"!==e.next()||i){if(r.includes(e.next())&&!i){"]"===e.next()&&e.index--;break}"\n"===e.next()?(e.col=0,e.ln++,"`"===r&&(n+="\n")):(i=!1,n+=e.next())}else i=!0;e.index++,e.col++}return e.remaining()?(e.index++,e.col++,e.update_src(),{ok:t?e.convertReservedChar(n):n,err:null}):{ok:null,err:"Unclosed string"}},parseAttrs=(t,n,e,r)=>{let i=r;const l=(e,r)=>{if(void 0===i[e])i[e]=r;else if(UNIQUE_ATTRS.includes(e))switch(n){case 0:i[e]=r;break;case 1:console.log(chalk.yellow(`Duplicate unique value found (${i[e]} and ${r}) ${t.file} ${t.line}:`+t.col)),i[e]=r;break;default:return{ok:null,err:`Duplicate unique value found (${i[e]} and ${r})`,rem:""}}else switch(typeof i[e]+" "+typeof r){case"string string":i[e]+=" "+r;break;case"boolean string":i[e]=r}};for(;t.remaining()&&"]"!==t.next();){t.stn();let r="";for(;t.remaining()&&!" \t\n='\"`]".includes(t.next());)r+=t.next(),t.index++,t.col++;if("]"===t.next()){if(r){var o=l(r,!0);if(o)return o}return t.index++,t.col++,t.update_src(),{ok:i,err:null}}if(!r)return{ok:null,err:"Empty attribute key!"};if("="===t.next()){LITERAL_DELIMITERS.includes(t.src[t.index+1])&&t.index++;var o=LITERAL_DELIMITERS.includes(t.next())?t.next():" \t\n]",s=(t.update_src(),t.parseStr(o,!1));if(s.err)return{ok:null,err:s.err,rem:""};t.index--,s.ok.replaceAll('"',"&quot;").split(/ +/g).forEach(e=>{e=l(r,e);if(e)return e})}else{s=l(r,!0);if(s)return s}t.index++}return t.remaining()?(t.index++,t.col++,t.update_src(),{ok:i,err:null}):{ok:null,err:"Unclosed attribute brackets",rem:""}},parseTag=(r,e)=>{let t,n;if(">#.{[>}".includes(r.next()))n=!0,t=e;else for(n=!1,t="";r.remaining()&&!"#. \t\n\"'`/>{[}".includes(r.next());)t+=r.next(),r.index++,r.col++;e=VOID_ELEMENTS.includes(t);if(!r.remaining())return{ok:{type:t,attrs:{},additional:{void:e,implicit:n}},err:null};let i={};if("#"===r.next()){let e="";for(r.index++,r.col++;r.remaining()&&!">{.[ \t\n".includes(r.next());)e+=r.next(),r.index++,r.col++;i.id=e}if(r.remaining()){if("."===r.next()){let e="";for(;r.remaining()&&!">{[ \t\n".includes(r.next());)e+=r.next(),r.index++,r.col++;i.class=e.replaceAll("."," ").slice(1)}if(r.remaining()&&"["===r.next()){r.index++,r.update_src();var l=r.parseAttrs(1,!0,i);if(l.err)return{ok:null,err:l.err};i=l.ok,r.index=0}}return{ok:{type:t,attrs:i,additional:{void:e,implicit:n}},err:null}};class Parser{src;path;ln;col;index;isBuild;macros;constructor(e,r,t=!0){this.src=e,this.path=r,this.ln=1,this.col=1,this.index=0,this.isBuild=t,this.macros=[Object.assign({},DEFAULT_MACROS)]}new(e,r,t=!0){return new Parser(e,r,t)}next=()=>next(this);remaining=()=>remaining(this);st=()=>st(this);stn=()=>stn(this);update_src=()=>update_src(this);parse=()=>{let e=[];for(;this.remaining();){var r=this.src,{ok:t,err:n}=this.parse_inner("div",!0,!1);if(n)return{ok:null,err:new Error(n,this.path,this.ln,this.col)};if(r===this.src)return{ok:null,err:new Error("Unable to parse remaining text",this.path,this.ln,this.col)};null!==t&&(e=[...e,...t])}return{ok:e,err:null}};parse_inner=(e,r,t)=>parse_inner(this,e,r,t);import_parse=e=>import_parse(this,e);handleImport=()=>handleImport(this);convertReservedChar=e=>convertReservedChar(this,e);parseComment=()=>parseComment(this);parseStr=(e,r)=>parseStr(this,e,r);parseAttrs=(e,r,t)=>parseAttrs(this,e,r,t);parseTag=e=>parseTag(this,e);get_macro=e=>get_macro(this,e);parse_macro_def=()=>parse_macro_def(this)}const fullStringify=function(e,r){var{ok:e,err:r}=new Parser(e,r,!0).parse();return r?{ok:null,err:r}:{ok:e.map(e=>e.toString()).join(""),err:null}},next=e=>e.src[e.index],remaining=e=>e.index<e.src.length,st=e=>{for(;e.remaining();){if(" "!==e.next()&&"\t"!==e.next()){e.update_src();break}e.col++,e.index++}e.remaining()||e.update_src()},stn=e=>{for(;e.remaining();)if(" "===e.next()||"\t"===e.next())e.col++,e.index++;else{if("\n"!==e.next()){e.update_src();break}e.col=1,e.index++,e.ln++}e.remaining()||e.update_src()},update_src=e=>{e.src=e.src.slice(e.index),e.index=0};export{fullStringify,snippet,full};